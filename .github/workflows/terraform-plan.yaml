name: Terraform Plan

on:
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  # Yandex Cloud Secrets
  YC_FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}
  YC_REGISTRY_ID: ${{ secrets.YC_REGISTRY_ID }}
  YC_ACCESS_KEY: ${{ secrets.YC_ACCESS_KEY }}
  YC_SECRET_KEY: ${{ secrets.YC_SECRET_KEY }}
  
  # Terraform Variables
  TF_VAR_folder_id: ${{ secrets.YC_FOLDER_ID }}
  TF_VAR_registry_id: ${{ secrets.YC_REGISTRY_ID }}
  TF_VAR_yc_access_key: ${{ secrets.YC_ACCESS_KEY }}
  TF_VAR_yc_secret_key: ${{ secrets.YC_SECRET_KEY }}
  
  #TF_VAR_domain_name: "stellarclaw.ru"
  #TF_VAR_s3_bucket_name: "docker-registry-stellarclaw"
  #TF_VAR_container_memory: "2048"
  #TF_VAR_vosk_images: "whisper-service"
  TF_VAR_images_tag: "v1.1.0"

  AWS_ACCESS_KEY_ID: ${{ secrets.YC_ACCESS_KEY }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.YC_SECRET_KEY }}
  # Рабочие директории
  TF_MICROSERVICE_DIR: "Terraform/microservice"
  TF_WEBSITE_DIR: "Terraform/website"

jobs:
  terraform-plan:
    runs-on: ubuntu-latest
    name: Terraform Plan
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.8.0

      - name: Install YC CLI
        run: |
          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash -s -- -n -i /home/runner/yc
          echo "/home/runner/yc/bin" >> $GITHUB_PATH
          chmod +x /home/runner/yc/bin/yc

      - name: Plan microservice
        working-directory: ${{ env.TF_MICROSERVICE_DIR }}
        run: |
          echo '${{ secrets.YC_SERVICE_ACCOUNT_KEY_JSON }}' > sa-key.json
          chmod 600 sa-key.json
          
          terraform init
          
          terraform plan


      - name: Plan website 
        working-directory: ${{ env.TF_WEBSITE_DIR }}
        run: |
          echo '${{ secrets.YC_SERVICE_ACCOUNT_KEY_JSON }}' > sa-key.json
          chmod 600 sa-key.json
          
          terraform init

          terraform plan
